#!/bin/bash
set -e

PLUGIN_JSON="plugins/holgis/plugin.json"

# Only bump if plugin.json exists
[ -f "$PLUGIN_JSON" ] || exit 0

# Check if any plugin files are staged (excluding plugin.json itself to avoid loops)
staged_plugin_files=$(git diff --cached --name-only -- 'plugins/holgis/agents/' 'plugins/holgis/skills/' 'plugins/holgis/.mcp.json' 'plugins/holgis/.lsp.json' | head -1 || true)

# Exit if no plugin files are staged
[ -n "$staged_plugin_files" ] || exit 0

# Read current version
current=$(grep '"version"' "$PLUGIN_JSON" | sed 's/.*"version": *"\([^"]*\)".*/\1/')

# Parse version parts
IFS='.' read -r major minor patch <<< "$current"

# Bump patch
new="$major.$minor.$((patch + 1))"

# Update plugin.json (macOS sed syntax)
sed -i '' "s/\"version\": *\"$current\"/\"version\": \"$new\"/" "$PLUGIN_JSON"

# Stage the updated file
git add "$PLUGIN_JSON"

echo "Version bumped: $current -> $new"
